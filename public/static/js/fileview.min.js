!function($){var Fileview=function(e){this.init(e)};Fileview.prototype={options:{},id:null,el:null,$el:null,$sidebar:null,$mainbar:null,$fileviewBody:null,$viewWrapper:null,$fileviewSwitch:null,$fileviewSwitchIcon:null,$newdirMenuItem:null,$newfileMenuItem:null,$sidebarmenu:null,$needselactions:null,$searchbar:null,showopt:!0,$fileupload:null,autoupload:!1,uptype:"gif|jpe?g|png|doc|docx|xls|ppt|pptx|xlsx|pdf|txt|zip|tar|gz|bz2|lz|mp3|mp4|flv|avi|mpeg|mpg|m2p|ogg|mkv|m4a|rm|rmvb|wmv|mov",maxFileSize:2147483647,maxnum:2147483647,showlimit:0,multiple:!0,nopreview:!1,donereload:!1,sbt:"",layerIndex:0,uploadobjects:[],$pagination:null,$sortbutton:null,$sortfieldmenuitem:null,noTabHead:!1,noTabLine:!1,nr_col_small:12,nr_col_large:4,url:null,views:null,viewtype_id:1,vmask:65535,defaultViewType:0,onLoad:null,onDone:null,keyword:null,type:-1,viewtype:0,pid:0,page:1,page_size:0,page_total:1,sortName:null,sortOrder:"desc",defaultSortName:null,nr_selected:0,data:null,uploadBigFile:function(e,t){for(var i="",a=document.cookie.split(";"),s=0;s<a.length;s++){var l=a[s].trim();if(0==l.indexOf("ssid")){i=l;break}}console.log("filename="+e);var o=window.location.protocol+"//"+window.location.host+this.url+"/bigupload/?tt=1&"+i+"&pid="+this.pid+"&lz="+t+"&lp="+e;o=o.replace("http","icloud"),console.log(o),window.location=o},newDirectory:function(){var e=this,t=e.getViewObjectPosById(e.viewtype_id);e.views[t].name;if(-1==e.type){"<td><div class='input-group'> <div class='input-icon'><i class='fa fa-folder-o'></i><input type='text' class='form-control' name='' value='新建文件夹'></div><span class='input-group-btn'><button class='btn '>保存</button></span> </div></td> ","<td></td> <td></td><td></td></tr>";var i=$("tbody",e.views[t].view),a=$("<tr><td></td> <td><div class='input-group'> <div class='input-icon'><i class='fa fa-folder-o'></i><input type='text' class='form-control' name='' value='新建文件夹'></div><span class='input-group-btn'><button class='btn '>保存</button></span> </div></td> <td></td> <td></td><td></td></tr>");i.prepend(a);var s=function(){showWaiting("请稍后...");var t={"params[name]":$("input",a).val(),"params[pid]":e.pid};$.post(e.url+"/newdir",t,function(t){closeWaiting(),0==t.status?(rui.showTSuccess("操作成功."),e.reload()):rui.showTError("操作失败:"+t.status)}).error(function(){closeWaiting(),rui.showTError("系统错误")})};$("button",a).on("click",function(){s()}),$("input",a).bind("keydown",function(e){13==(window.event||arguments.callee.caller.arguments[0]).keyCode&&s()})}else console.log("unknow view type!")},newFile:function(){console.log("IN..."),console.log("OUT...")},setType:function(e){switch(this.type=parseInt(e),this.page=1,this.nr_selected=0,this.type){case 4:case 1:this.page_size=0,this.viewtype_id=1;break;case 2:case 8:case 16:case 0:this.page_size=0,this.viewtype_id=4;break;default:this.viewtype_id=4,this.page_size=2147483647}rui.cookie("last_fileview_type_"+this.id,this.viewtype_id),rui.cookie("cookie_type_"+this.id,this.type)},showSelectInfo:function(){var e=this,t="选中"+e.nr_selected+"/"+e.data.total+"个";if(e.$selectInfo.html(t),e.nr_selected>0){var i=$(".needselactions",e.$fileupload);i.removeClass("nosel"),e.nr_selected>1?$(".edit",i).prop("disabled",!0):$(".edit",i).prop("disabled",!1)}else $(".needselactions",e.$fileupload).addClass("nosel");var a=[],s=null;$("input[type='checkbox']",e.$viewWrapper).each(function(){if(this.checked){var t=parseInt($(this).attr("data-index"));s=e.data.rows[t],a.push(s)}}),window.rows=a,window.row=s},getSelectedIDs:function(){var e=[];return this.nr_selected>0&&$("input[type='checkbox']",this.$viewWrapper).each(function(){if($(this).is(":checked")){var t=$(this).val();e.push(t)}}),e},getFirstSelectedID:function(){var e=0;return this.nr_selected>0&&$("input[type='checkbox']",this.$viewWrapper).each(function(){$(this).is(":checked")&&(e=$(this).val())}),e},pubAll:function(){var e=this.getSelectedIDs();if(console.log(e),0==e.length)return!1;e=e.toString(),console.log(e),rui.redirect(this.url+"/pubcontent/?id="+e)},deleteAll:function(){var e=this,i=e.getSelectedIDs();if(0==i.length)return!1;var a={id:i};bootbox.setLocale(G.lang),bootbox.confirm(t("Are you sure to delete?"),function(t){t&&$.post(e.url+"/delete",a,function(t){0==t.status?(rui.showTSuccess("操作成功."),e.reload()):rui.showTError("操作失败:"+t.status)}).error(function(){rui.showTError("系统错误")})})},movetoAll:function(){var e=this,t=e.getSelectedIDs();if(0==t.length)return!1;layer.open({type:2,title:"移动到",shadeClose:!1,shade:.2,shift:10,area:["600px","400px"],content:e.url+"/selectdir",btn:["确定","取消"],btn2:function(e,t){},yes:function(i,a){var s=window["layui-layer-iframe"+i].selected_id;e.moveto(t,s)&&layer.close(i)},success:function(e,t){console.log(t)}})},initEvent:function(){var e=this;$(".reload",e.$el).on("click",function(t){t.preventDefault(),e.reload()}),e.$fileviewSwitch.on("click",function(t){t.preventDefault();var i=0,a=-1,s=0,l=e.views.length;if(0==l)return-1;for(i=0;i<l;i++)if(e.viewtype_id==e.views[i].id){a=i;break}s=-1==a?a=0:(a+1)%l;var o=e.views[a],n=e.views[s];e.$viewWrapper.empty(),e.$viewWrapper.append(n.view),e.initEventDoneForViewWrapper(),e.$fileviewSwitchIcon.removeClass(o.class),e.$fileviewSwitchIcon.addClass(n.class),e.viewtype_id=n.id,rui.cookie("last_fileview_type_"+e.id,e.viewtype_id)}),e.$sortbutton.on("click",function(t){if(t.preventDefault(),e.sortName||(e.sortName=e.defaultSortName),e.sortName){var i=e.$sortbutton.find("i");"asc"==e.sortOrder?(i.removeClass("fa-sort-alpha-asc"),i.addClass("fa-sort-alpha-desc"),e.sortOrder="desc"):(i.removeClass("fa-sort-alpha-desc"),i.addClass("fa-sort-alpha-asc"),e.sortOrder="asc"),e.reload()}}),e.$menuitem.on("click",function(t){t.preventDefault();var i=$(this).attr("data-type");e.$menuitem.closest("li").removeClass("active"),$(this).closest("li").addClass("active"),e.setType(i),e.reload()}),$(".fv-menu-item",e.$searchbar).on("click",function(t){t.preventDefault();var i=$(this).attr("data-type");$(".fv-menu-item",e.$searchbar).closest("li").removeClass("active"),$(this).closest("li").addClass("active");var a=$(this).attr("data-title");$("#btnTypeTitle",e.$searchbar).html(a),e.setType(i),e.reload()}),e.$newdirMenuItem.on("click",function(t){t.preventDefault(),e.newDirectory()}),e.$newfileMenuItem.on("click",function(t){t.preventDefault(),e.newFile()}),$(".fvcheckall",e.$el).on("change",function(t){t.preventDefault();var i=this.checked,a=0;$("input[type='checkbox']",e.$viewWrapper).each(function(){$(this).prop("checked",i);var e=$(this).closest(".widget-thumb").hasClass("selected");i!=e&&$(this).closest(".widget-thumb").toggleClass("selected"),i&&a++}),e.nr_selected=a,e.showSelectInfo()}),$(".pub",e.$needselactions).on("click",function(t){t.preventDefault(),e.pubAll()}),$(".edit",e.$needselactions).on("click",function(t){t.preventDefault();var i=e.getFirstSelectedID();e.editFile(i)}),$(".delete",e.$needselactions).on("click",function(t){t.preventDefault(),e.deleteAll()}),$(".moveto",e.$needselactions).on("click",function(t){t.preventDefault(),e.movetoAll()}),$(".keyword",e.$searchbar).bind("keydown",function(t){if(13==(window.event||arguments.callee.caller.arguments[0]).keyCode){var i=$(this).val().trim();console.log(i),(i||e.keyword!=i)&&(e.keyword=i,e.reload())}}),$("#btnSearch",e.$searchbar).on("click",function(t){e.reload()}),$(".fv-sidebar-switch",e.$mainbar).on("click",function(t){var i=$("i",$(this));i.hasClass("fa-angle-left")?(i.removeClass("fa-angle-left"),i.addClass("fa-angle-right")):(i.removeClass("fa-angle-right"),i.addClass("fa-angle-left")),e.$el.toggleClass("nosidebar")})},showGallery:function(e){var t=[],a=0,s=0;for(i=0;i<this.data.rows.length;i++){var l=this.data.rows[i];if(4==l.type||1==l.type){var o=l.url,n=l.mimetypename;if(1==l.type){if(1==l.converted)continue;2==l.converted&&(n="video/mp4"),o=l.playurl}var r={title:l.title,href:o,type:n,poster:l.previewLargeUrl};t.push(r),e==l.id&&(s=a),a++}}blueimp.Gallery(t,{container:"#blueimp-gallery",carousel:!0,index:s})},initEventDoneForViewWrapper:function(){var e=this,t=$(".sortable",e.$viewWrapper);t.on("click",function(i){i.preventDefault();var a=$(this).closest("th").attr("data-id"),s="asc";$(this).hasClass("asc")?(s="desc",t.removeClass("asc"),$(this).addClass("desc")):(s="asc",t.removeClass("desc"),$(this).addClass("asc")),e.sortName=a,e.sortOrder=s,e.reload()}),$(".videobox",e.$viewWrapper).on("click",function(e){e.preventDefault();var t=$(this).attr("data-url"),i=$(this).attr("data-id"),a=$(this).attr("data-poster"),s="videoplay"+i+"_"+Math.ceil(1e5*Math.random()),l="video/mp4";t.match(/^.+.m3u8$/)&&(l="application/x-mpegURL");var o=null;layer.open({type:1,title:"播放",shadeClose:!1,maxmin:!0,shade:.2,shift:10,area:["600px","400px"],content:"<video id='"+s+"' class='video-js vjs-default-skin vjs-big-play-centered' src='"+t+"' controls width='100%' height='100%' style='width:100%;height:100%;' autoplay><source src='"+t+"' type='"+l+"'> </video>",success:function(e){o&&(o.destroy(),o=null),o=videojs(s,{poster:a})}})}),$(".audiobox",e.$viewWrapper).on("click",function(e){e.preventDefault();var t=$(this).attr("data-url"),i="audioplay"+$(this).attr("data-id")+"_"+Math.ceil(1e5*Math.random()),a=null;layer.open({type:1,title:"播放",shadeClose:!1,shade:.2,shift:10,maxmin:!1,area:["600px","200px"],content:"<audio id='"+i+"' class='video-js vjs-default-skin vjs-big-play-centered' src='"+t+"' controls width='600' height='320' style='width:100%;height:100%;' autoplay><source src='"+t+"' type='audio/mp3'> </audio>",success:function(e){a&&(a.destroy(),a=null),a=videojs(i)}})}),$(".isdir",e.$viewWrapper).on("click",function(t){t.preventDefault();var i=parseInt($(this).attr("data-id"));e.pid=i,e.reload()}),$(".contextmenu-item").contextmenu({target:"#optContextMenu",onItem:function(t,i){var a=$(i.target).attr("data-id"),s=$(t).attr("data-id");switch(console.log("action="+a+",id="+s),a){case"detail":e.showFile(s);break;case"download":e.downloadFile(s);break;case"rename":break;case"edit":e.editFile(s);break;case"remove":e.deleteFile(s);break;case"moveto":e.onMoveto(s)}}}).on("click",function(e){e.stopPropagation(),$(this).contextmenu("show",e)}),$('input[type="checkbox"]',e.$viewWrapper).on("change",function(t){t.preventDefault();var i=$(this).is(":checked");$(this).val();$(this).closest(".widget-thumb").toggleClass("selected"),i?e.nr_selected++:e.nr_selected--,e.showSelectInfo()}),$(".filerow",e.$viewWrapper).on("dblclick",function(t){t.preventDefault();var i=$(this).attr("data-id");e.showFile(i)}),$(".gallery",e.$viewWrapper).on("click",function(t){t.preventDefault();var i=$(this).attr("data-id");e.showGallery(i)})},deleteFile:function(e){var i=this,a={id:e};bootbox.setLocale(G.lang),bootbox.confirm(t("Are you sure to delete?"),function(e){e&&$.post(i.url+"/delete",a,function(e){0==e.status?(rui.showTSuccess("操作成功."),i.reload()):rui.showTError("操作失败:"+e.status)}).error(function(){rui.showTError("系统错误")})})},initEventDone:function(){var e=this;$(".firstPage",e.$pagination).on("click",function(t){t.preventDefault(),e.page=1,e.reload()}),$(".prevPage",e.$pagination).on("click",function(t){t.preventDefault(),e.page--,e.page<1&&(e.page=1),e.reload()}),$(".nextPage",e.$pagination).on("click",function(t){t.preventDefault(),e.page++,e.page>e.page_total&&(e.page=e.page_total),e.reload()}),$(".lastPage",e.$pagination).on("click",function(t){t.preventDefault(),e.page=e.page_total,e.reload()}),$(".changePagesize",e.$pagination).on("change",function(t){t.preventDefault();var i=parseInt($(this).val());(i>e.total||i<0)&&(i=e.total),e.page_size=i,e.reload()}),$(".changePage",e.$pagination).on("change",function(t){t.preventDefault();var i=parseInt($(this).val());i>=1&&i<=e.page_total&&(e.page=i,e.reload())}),$(".sortmenuitem",e.$sortfieldmenuitem).on("click",function(t){t.preventDefault();var i=$(this).closest("li").attr("data-id");""==e.sortOrde&&(e.sortOrde="desc"),e.sortName=i,e.reload()}),e.initEventDoneForViewWrapper()},editFile:function(e){var t=this.url+"/edit?dlg=1&id="+e;layer.open({type:2,title:"编辑",shadeClose:!1,shade:.2,shift:10,area:["70%","65%"],content:t})},showFile:function(e){var i=this.url+"/detail?dlg=1&id="+e;layer.open({type:2,title:t("Detail"),shadeClose:!1,shade:.2,shift:10,area:["70%","65%"],content:i})},getRowById:function(e){for(i=0;i<this.data.rows.length;i++)if(e==this.data.rows[i].id)return this.data.rows[i];return null},downloadFile:function(e){var t=this.getRowById(e);if(!t)return console.log("no data! id="+e),!1;if(1==t.isdir)return console.log("dir cannot download! id="+e),!1;var i=this.url+"/download?id="+e;rui.redirect(i)},moveto:function(e,t){var i=this;if(_.isArray(e))var a={"params[id][]":e,"params[new_pid]":t};else a={"params[id]":e,"params[new_pid]":t};return $.post(i.url+"/moveto",a,function(e){0==e.status?(rui.showTSuccess("操作成功."),i.reload()):rui.showTError("操作失败!")}).error(function(){rui.showTError("系统错误！")}).always(function(){}),!0},onMoveto:function(e){var t=this;layer.open({type:2,title:"移动到",shadeClose:!1,shade:.2,shift:10,area:["600px","400px"],content:t.url+"/selectdir",btn:["确定","取消"],btn2:function(e,t){},yes:function(i,a){var s=window["layui-layer-iframe"+i].selected_id;t.moveto(e,s)&&layer.close(i)},success:function(e,t){console.log(t)}})},insertFileviewPage:function(e,t,i,a){var s=$(a);this.views.push({id:e,name:t,class:i,tpl:a,view:s})},loadFileviewWithLarge:function(e){var t,i,a,s,l=this.nr_col_large,o=e.rows.length,n=Math.floor(12/l),r=Math.ceil(o/l),d=[];_.each(e.rows,function(e,t){d.push(e)});var c='<div class="portlet-body fileview-large">';for(t=0;t<r;t++){for(c+='<div class="row">',i=0;i<l&&!((a=t*l+i)>=o);i++){var u="",p=(s=d[a]).url;1==s.isdir?(u='class="isdir"',p="#"):(1==s.type&&(p=s.playurl,u='class="videobox" data-url="'+s.playurl+'"'),2==s.type?(p=s.playurl,u='class="audiobox" data-url="'+s.playurl+'"'):4==s.type&&(u=' class="gallery" data-mygallery="'+p+'" ')),c+='<div class="col-md-'+n+" col-sm-6 col-xs-12 lvi"+n+'"><div class="widget-thumb widget-bg-color-blue margin-bottom-20 filerow" id="file_'+s.id+'" data-id="'+s.id+'" data-index="'+a+'"><div class="widget-thumb-toolbar"><input type="checkbox" class="icheckbox" name="params[id][]" value="'+s.id+'" value="'+s.id+'" data-index="'+a+'"></div>   <div class="widget-thumb-wrap">      <i class="widget-thumb-icon ">       <a href="'+p+'" data-id='+s.id+' title="'+s.title+'" '+u+' >         <img src="'+s.previewUrl+'" class="img-fluid" alt="'+s.title+'">        </a> </i>    </div>   <div class="widget-thumb-title ac"><a href="'+s.url+'" data-id='+s.id+' title="'+s.title+'" '+u+">"+s.title+"</a> "+s.extinfo+" </div></div></div>"}c+="</div>"}return 0==r&&(c+='<div class="ac"><i class="fa null"></i> <div class="clearfix"></div><span class="bignotice">本来无一物 </span> </div>'),c+="</div>",this.insertFileviewPage(1,"large","fa-th-large",c),!0},loadFileviewWithSmall:function(e){var t,i,a,s,l=this.nr_col_small,o=e.rows.length,n=Math.floor(12/l),r=Math.ceil(o/l),d=[];_.each(e.rows,function(e,t){d.push(e)});var c='<div class="portlet-body fileview-small">';for(t=0;t<r;t++){for(c+='<div class="row">',i=0;i<l&&!((a=t*l+i)>=o);i++){var u="",p=(s=d[a]).url;1==s.isdir?(u='class="isdir"',p="#"):1==s.type?u='class="videobox" data-url="'+(p=s.tplayurl)+'"':2==s.type?u='class="audiobox" data-url="'+(p=s.tplayurl)+'"':4==s.type&&(u='class="gallery" data-mygallery="'+p+'"',p=s.photo),c+='<div class="col-md-'+n+" col-sm-"+n+" col-xs-"+n+" lvi"+n+'"><div class="widget-thumb widget-bg-color-small margin-bottom-20 "><div class="widget-thumb-toolbar"><input type="checkbox" class="icheckbox" name="params[id][]" value="'+s.id+'" data-index="'+a+'"></div>   <div class="widget-thumb-wrap ">      <a href="'+p+'" '+u+" data-id="+s.id+' title="'+s.title+'">      <i class="widget-thumb-icon "><img src="'+s.previewUrl+'" class="img-fluid"> </i>        </a>    </div><div class="widget-thumb-title ac"><a href="'+s.url+'" '+u+' title="'+s.title+'">'+s.title+"</a>"+s.extinfo+"</div></div></div>"}c+="</div>"}return 0==r&&(c+='<div class="ac"><i class="fa null"></i> <div class="clearfix"></div><span class="bignotice">本来无一物 </span> </div>'),c+="</div>",this.insertFileviewPage(8,"small","fa-th",c),!0},loadFileviewWithListimg:function(e){e.num,e.total;var t='<div class="portlet-body fileview-listimg"> <div class="mt-element-list"><div class="mt-list-container list-news ext-1"><ul>';return _.each(e.rows,function(e,i){var a='<li class="mt-list-item">    <div class="list-thumb">        <a href="javascript:;">            <img src="'+e.previewUrl+'" />        </a>    </div>    <div class="list-datetime  font-gray pull-right"><i> 最后更新： '+e.ts+" / 更新人："+e.uid+'</i> </div>    <div class="list-item-content">        <h3 class="title">            <a href="javascript:;">'+e.name+e.extinfo+'</a>        </h3>         <div class="author">           <span>创建：'+e.cuid+" </span> <span> 创建时间："+e.ctime+"</span>        </div>        <span>"+e.summary+'</span>    </div><div class="clearfix"></div></li>';t+=a}),t+="</ul></div>",t+="</div>",this.insertFileviewPage(2,"listimg","fa-th-list",t),!0},getPopMenuBar:function(e){return'<div class="btn-group"><button class="btn default bt-xs contextmenu-item" data-id="'+e.id+'"><i class="fa fa-ellipsis-h"></i></div>'},loadFileviewWithDetail:function(e){var t=this,i=e.fields,a='<div class="portlet-body fileview-detail">    <div class="table-scrollable">        <table class="table table-hover table-bordered">';if(!t.noTabHead){a+="            <thead>  <tr>";var s="";i.id.sortable&&(s="sortable both ","id"==t.sortName&&(s+=t.sortOrder)),a+='<th data-id="id" width="80"> ',a+='<div class="th-inner '+s+'">'+i.id.title+"</div>",a+=" </th>",s="",i.name.sortable&&(s="sortable both ","name"==t.sortName&&(s+=t.sortOrder)),a+='<th data-id="name"> ',a+='<div class="th-inner '+s+'">'+i.name.title+"</div>",a+=" </th>",_.each(i,function(e,i){if("id"!=i&&"name"!=i){var s="";e.sortable&&(s="sortable both ",t.sortName==i&&(s+=t.sortOrder)),a+='<th data-id="'+i+'"> ',a+='<div class="th-inner '+s+'">'+e.title+"</div>",a+=" </th>"}}),t.showopt&&(a+='<th data-id="opt" width="100"> ',a+='<div class="th-inner">操作</div>',a+=" </th>"),a+="</tr></thead>"}a+="<tbody>";return _.each(e.rows,function(e,s){var l=e[t.data.pkey],o='<tr class="filerow" id="file_'+e.id+'" data-id="'+e.id+'" data-index="'+s+'">';o+='  <td> <label class="checkbox-inline"> <input type="checkbox" name="params[id][]" value="'+l+'" data-index="'+s+'" /> '+l+" </label></td>";var n="",r=e.url;1==e.isdir?(n='class="isdir"',r="#"):1==e.type?n='class="videobox" data-url="'+(r=e.tplayurl)+'"':2==e.type?n='class="audiobox" data-url="'+(r=e.tplayurl)+'"':4==e.type&&(r=e.photo,n='class="gallery" data-mygallery="'+e.url+'"'),o+="  <td> <img src="+e.icon+' width=24 height=24 > <a href="'+r+'" '+n+' data-id="'+l+'">'+e.name+"</a>"+e.extinfo+"</td>",_.each(i,function(t,i){if("id"!=i&&"name"!=i){var a=e[i];o+="  <td> "+a+" </td>"}}),t.showopt&&(o+="  <td> "+t.getPopMenuBar(e)+" </td>"),a+=o+="</tr>",0}),a+="</tbody></table>",a+="</div>",a+="</div>",t.insertFileviewPage(4,"detail","fa-list",a),!0},loadPaginationBar:function(e){var t=e.total,i=e.num,a=e.page,s=e.page_size,l=(a-1)*s+1,o=l+i-1,n=Math.ceil(t/s);if(n<=1)return!1;var r='<div class="portlet-body">  <div class="row t">          <div class="col-md-6 col-sm-6 col-xs-6">               <span class="pagination-info">                  显示记录第'+l+"至"+o+"/"+t+'条，每页<input type="text" name="param_page_size" class="pagination-input changePagesize" placeholder="条数" value="'+s+'" />条 共'+n+'页               </span>          </div>          <div class="col-md-6 col-sm-6 col-xs-6 ac ">              <ul class="pagination pagination-lg">              <li>                          <a href="javascript:;" class="firstPage" >                               <i class="fa fa-angle-double-left"></i>                          </a>                      </li>                      <li>                          <a href="javascript:;" class="prevPage" >                              <i class="fa fa-angle-left"></i>                          </a>                      </li>                      <li>                          <span><input type="text" name="param_page" class="pagination-input changePage" placeholder="跳到" value="'+a+'" /></span>                      </li>                      <li>                          <a href="javascript:;" class="nextPage">                              <i class="fa fa-angle-right"></i>                          </a>                      </li>                      <li>                          <a href="javascript:;" class="lastPage">                              <i class="fa fa-angle-double-right"></i>                          </a>                      </li>                  </ul>          </div>  </div></div>';return this.$pagination=$(r),this.$fileviewBody.append(this.$pagination),this.total=t,this.page_total=n,!0},getViewObjectPosById:function(e){for(var t=0;t<this.views.length;t++)if(this.views[t].id==e)return t;return 0},showFileview:function(e){var t=this,i=(t.views.length,t.viewtype_id);_.each(t.views,function(e,i){t.$fileviewSwitchIcon.removeClass(e.class)});var a=t.getViewObjectPosById(i),s=t.views[a];t.$viewWrapper.empty(),t.$viewWrapper.append(s.view),t.$fileviewSwitchIcon.addClass(s.class),t.viewtype_id=i},done:function(e){this.initEventDone(),this.onDone&&this.onDone(this,e)},loadDataInfo:function(e){var t=this;if(t.data=e,e.sort?(t.defaultSortName=t.sortName=e.sort,t.sortOrder=e.order):_.each(e.fields,function(e,i){t.defaultSortName||!_.isUndefined(e.sortable)&&e.sortable&&(t.defaultSortName=i)}),t.sbt=e.sbt,t.$sortfieldmenuitem.empty(),e.fields){var i="";_.each(e.fields,function(t,a){var s="",l="fa-space";e.sort==a&&(s='class="active"',l="fa-check"),i+="<li "+s+'  data-id="'+a+'"> <a href="javascript:;" class="sortmenuitem"><i class="fa '+l+'"></i>  '+t.title+" </a></li>"}),i&&t.$sortfieldmenuitem.append($(i))}var a=$("<div class='fileview-view-wrapper'></div>");t.$fileviewBody.append(a),t.$viewWrapper=a,t.showSelectInfo()},clear:function(){this.$fileviewBody.empty(),this.views=[],this.nr_selected=0},loadPostion:function(e){var t=this,i='<a href="#" class="position" data-id="0">全部</a>';_.each(e,function(e,t){i+='<a href="#" class="position" data-id="'+e.id+'" > <i class="fa fa-angle-right"> </i> '+e.name+" </a>"});var a=$(".fvcurrentpostion",t.$fileview);a.html($(i)),$(".position",a).on("click",function(e){var i=$(this).attr("data-id");t.pid=i,t.reload()})},loadData:function(e){this.clear(),this.loadDataInfo(e),this.loadPostion(e.positions),1&this.vmask&&this.loadFileviewWithLarge(e),2&this.vmask&&this.loadFileviewWithListimg(e),4&this.vmask&&this.loadFileviewWithDetail(e),8&this.vmask&&this.loadFileviewWithSmall(e),this.loadPaginationBar(e),this.showFileview(),this.done(e)},load:function(){var e=this;e.onLoad&&e.onLoad(e);var t=e.$el.closest("form").serializeArray();if($('textarea.form-filter, select.form-filter, select.form-control.select2me, input.form-filter:not([type="radio"],[type="checkbox"])',e.$searchbar).each(function(){i={name:$(this).attr("name"),value:$(this).val()},t.push(i)}),$('input.form-filter[type="checkbox"]:checked',e.$searchbar).each(function(){i={name:$(this).attr("name"),value:$(this).val()},t.push(i)}),$('input.form-filter[type="radio"]:checked',e.$searchbar).each(function(){i={name:$(this).attr("name"),value:$(this).val()},t.push(i)}),e.page>0){var i={name:"page",value:e.page};t.push(i)}e.page_size>0&&(i={name:"page_size",value:e.page_size},t.push(i)),e.sortName&&(i={name:"sort",value:e.sortName},t.push(i),i={name:"order",value:e.sortOrder},t.push(i)),-1!=e.type?(i={name:"params[type]",value:e.type},t.push(i)):(i={name:"viewtype",value:2},i={name:"params[pid]",value:e.pid},t.push(i)),showWaiting(),$.post(e.url+"/fileview",t,function(t){0==t.status?e.loadData(t.data.fileview):rui.showTError("操作失败:"+t.status,".form")}).error(function(){rui.showTError("系统错误！")}).always(function(){closeWaiting()})},initUploadAction:function(){var self=this,fileupload=self.$fileupload.fileupload({type:"POST",url:self.url+"/upload",disableImageResize:!1,autoUpload:self.autoupload,disableImageResize:/Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),maxFileSize:self.maxFileSize,acceptFileTypes:eval("/(.)("+self.uptype+")$/i"),uploadTemplateId:null,downloadTemplateId:null,uploadTemplate:function(e){var t=$(),a=e.files.length;for(i=0;i<a;i++){var s=e.files[i],l='<tr class="template-upload fade"> <td>    <span class="preview"></span></td><td>    <p class="name">'+s.name+"</p>";s.error&&(l+='    <strong class="error text-danger label label-danger">'+s.error+"</strong>"),l+='</td><td>    <p class="size">Processing...</p>    <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">    <div class="progress-bar progress-bar-success" style="width:0%;"></div>    </div></td><td width="160">',e.options.autoUpload||(l+='<button class="btn btn-sm blue start" disabled><i class="fa fa-upload"></i><span>上传</span></button>'),l+='<button class="btn btn-sm red cancel">     <i class="fa fa-ban"></i>     <span>取消</span></button>',l+="</td></tr>",t=t.add($(l))}return t},downloadTemplate:function(e){var t=$(),a=e.files.length;for(i=0;i<a;i++){var s=e.files[i],l=(self.url,s.url,s.previewUrl),o=(s.deleteUrl,s.downloadUrl);"string"==typeof s.size&&(s.size=parseInt(s.size));(s.oid>0||1==s.upload)&&("selected","checked");var n='<tr class="template-download fade">    <td>        <span class="preview">                <a href="'+l+"?x=1024&y=1024&id="+s.id+'" title="'+s.name+'" download="'+s.name+'" data-gallery><img src="'+l+"?id="+s.id+'"></a>        </span>    </td>    <td>';s.error?n+='<div><span class="label label-danger">'+s.error+"</span></div>":n+='<a href="'+o+'" title="'+s.name+'" >'+s.name+"</a>",n+='    </td>    <td>        <span class="size">'+e.formatFileSize(s.size)+"</span>    </td>    <td>",s.error?n+='<button class="btn red btn-sm">失败</button>':n+='<button class="btn green btn-sm">成功</button>';var r=$(n+="    </td></tr>");if(t=t.add(r),i+1==self.maxnum){$(".uploadfileinput",self.$fileupload).hide();break}}return t}}).on("fileuploadadd",function(e,data){var acceptFileTypes=eval("/(.)("+self.uptype+")$/i"),error=!1;for(i=0;i<data.originalFiles.length;i++){var name=data.originalFiles[i].name;if(!acceptFileTypes.test(name))return void rui.showTError("上传文件类型错误！");var size=data.originalFiles[i].size;size>self.maxFileSize&&(self.uploadBigFile(name,size),error=!0)}if(error)return!1;self.uploadobjects.push(data);var el=$("#fvUploadTpl",self.$filepload);if(el.removeClass("hidden"),0==self.layerIndex){function cancelUpload(e,t){for(layer.close(e),el.hide(),el.addClass("hidden"),i=0;i<self.uploadobjects.length;i++){var a=self.uploadobjects[i];a.abort(),a.context.empty(),a.context.remove()}self.uploadobjects=[],$(".files",el).empty(),self.layerIndex=0}var index=layer.open({skin:"fvlayer",type:1,title:"上传",shadeClose:!1,shade:.2,shift:10,area:["55%","70%"],content:el,btn:["上传","关闭"],btn2:cancelUpload,cancel:cancelUpload,yes:function(e,t){for(i=0;i<self.uploadobjects.length;i++)self.uploadobjects[i].submit();$(".layui-layer-btn0").hide()}});self.layerIndex=index}}).on("fileuploadsubmit",function(e,t){t.formData={sbt:self.sbt,model:self.model,oid:self.oid,viewcontent:self.viewcontent,pid:self.pid}}).on("fileuploaddone",function(e,t){if(t.result.status<0)return rui.showTError("操作失败:"+t.result.status),!1;rui.showTSuccess("上传成功"),self.uploadobjects=[],self.reload()}).on("fileuploadcompleted",function(e,t){self.$fileupload.on("click",".download",function(e){e.preventDefault();var t=$(this).attr("href");rui.redirect(t)})}).on("fileuploaddestroy",function(e,i){return rui.ask(t("Are you sure to delete?"))}).on("fileuploaddestroyed",function(e,t){$(".uploadfileinput",self.$fileupload).show()})},initLoad:function(){var e=this.viewtype_id,t=rui.cookie("last_fileview_type_"+this.id);t&&t>0?e=t:this.defaultViewType>0&&(e=this.defaultViewType),this.viewtype_id=e;var i=this.type,a=rui.cookie("cookie_type_"+this.id);if(a&&a>0&&(i=a),this.type=i,_.isUndefined(this.$el.attr("data-type"))||(i=parseInt(this.$el.attr("data-type")))>=-1&&i<=16&&(this.type=i),this.$menuitem.closest("li").removeClass("active"),-1!=i&&$("#typeid_"+i,this.$sidebarmenu).closest("li").addClass("active"),-1!=i){var s=$("#typeid_"+i,this.$searchbar),l=s.attr("data-title");$("#btnTypeTitle",this.$searchbar).html(l),s.closest("li").addClass("active")}},init:function(e){var t=$(e.el);_.isUndefined(e.onLoad)||(this.onLoad=e.onLoad),_.isUndefined(e.onDone)||(this.onDone=e.onDone);var i=$(".fileview-body",t);if(i.length<=0)return!1;var a=$(".fileviewSwitch",t);if(a.length<=0)return!1;var s,l=$("i",a);if(l.length<=0)return!1;(_.isUndefined(t.attr("id"))?this.id="fileview"+Math.ceil(1e3*Math.random()):this.id=t.attr("id"),_.isUndefined(t.attr("data-col_small")))||(s=parseInt(t.attr("data-col_small")))>=1&&s<=12&&(this.nr_col_small=nr_col_small);_.isUndefined(t.attr("data-col_large"))||(s=parseInt(t.attr("data-col_large")))>=1&&s<=12&&(this.nr_col_large=nr_col_large);if(_.isUndefined(t.attr("data-url"))||(this.url=t.attr("data-url")),!this.url)return!1;if(void 0!==t.attr("data-autoupload")&&(this.autoupload=!0),void 0!==t.attr("data-single")&&(this.multiple=!1),void 0!==t.attr("data-maxsize")&&(this.maxFileSize=parseInt(t.attr("data-maxsize"))),void 0!==t.attr("data-maxnum")&&(this.maxnum=parseInt(t.attr("data-maxnum"))),void 0!==t.attr("data-uptype")&&(this.uptype=t.attr("data-uptype")),_.isUndefined(t.attr("data-notabhead"))||(this.noTabHead=!0),!_.isUndefined(t.attr("data-vmask"))){var o=parseInt(t.attr("data-vmask"));o>0&&(this.vmask=o)}if(!_.isUndefined(t.attr("data-defaultviewtype"))){var n=parseInt(t.attr("data-defaultviewtype"));n>0&&(this.defaultViewType=n)}if(_.isUndefined(t.attr("data-keyword"))||(this.keyword=t.attr("data-keyword")),!_.isUndefined(t.attr("data-showopt"))){var r=parseInt(t.attr("data-showopt"));this.showopt=1==r}this.el=e.el,this.$el=t,this.$fileviewBody=i,this.$fileviewSwitch=a,this.$fileviewSwitchIcon=l,this.$fileupload=$("#fileupload",t),this.$sidebar=$(".fv-sidebar",t),this.$sidebarmenu=$(".fv-sidebar-menu",this.$sidebar),this.$menuitem=$(".fv-menu-item",this.$sidebar),this.$mainbar=$(".fv-main",t),this.$newdirMenuItem=$(".newdir",t),this.$newfileMenuItem=$(".newfile",t),this.$sortbutton=$(".sortbutton",t),this.$sortfieldmenuitem=$(".sortfieldmenuitem",t),this.$selectInfo=$("#selectInfo",t),this.$needselactions=$(".needselactions",t),this.$searchbar=$("#searchbar",t),this.views=new Array,this.initLoad(),this.load(),this.initUploadAction(),this.initEvent()},reload:function(){this.load()}},$.fn.fileview=function(e){"string"==typeof e&&(e={text:e}),e=$.extend({},{sort:!0},e);return this.each(function(){return t=this,e.el=t,new Fileview(e);var t})}}(jQuery);