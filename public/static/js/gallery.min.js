!function(a){var t=function(a){this.initialize(a)};t.prototype={el:null,id:"_",url:window.location.href,mid:0,multiple:!0,width:240,height:180,maxnum:1024,columns:3,ctype:"",downloadAction:!0,settingAction:!0,deleteAction:!0,noabar:!1,name:"_",rows:[],initialize:function(t){var e=this;e.el=t;var i="";void 0!==t.attr("data-url")&&(e.url=t.attr("data-url")),void 0!==t.attr("data-mid")&&(e.mid=parseInt(t.attr("data-mid"))),void 0!==t.attr("data-single")&&(e.multiple=!1),void 0!==t.attr("data-maxnum")&&(e.maxnum=parseInt(t.attr("data-maxnum"))),void 0!==t.attr("data-columns")&&(e.columns=parseInt(t.attr("data-columns"))),void 0!==t.attr("data-ctype")&&(e.ctype=t.attr("data-ctype")),void 0!==t.attr("data-width")&&(e.width=parseInt(t.attr("data-width"))),void 0!==t.attr("data-height")&&(e.height=parseInt(t.attr("data-height"))),void 0!==t.attr("id")&&(i=t.attr("id")),void 0!==t.attr("data-name")&&(e.name=t.attr("data-name")),void 0!==t.attr("data-noabar")&&(e.noabar=!0),void 0!==t.attr("data-nosetting")&&(e.settingAction=!1),void 0!==t.attr("data-nodelete")&&(e.deleteAction=!1),e.initGallery(),i||(i="_"+e.width),e.id=i;var l=a("#param_"+e.name).val();a.ajax({url:e.url+"/selected",dataType:"json",data:{mid:e.mid,name:e.name,aids:l}}).always(function(){a(this).removeClass("gallery-processing")}).done(function(a){e.loadData(a.data)})},initGallery:function(){var t=this,e="blueimp-gallery_"+t.id,l="<style>.gallery-placeholder{width:"+t.width+"px; height:"+t.height+'px;}</style><div id="'+e+'" class="blueimp-gallery blueimp-gallery-controls" data-filter=":even"><div class="slides"> </div><h3 class="title"></h3><a class="prev"> ‹ </a><a class="next"> › </a><a class="close white"> </a><a class="play-pause"> </a><ol class="indicator"> </ol></div> ',r='<div class="gallery-tile" style="width:'+t.width+"px; height:"+t.height+'px;"> <a href="#" class="gallery-button"> <i class="fa fa-plus select" style="line-height:'+t.height+'px;"> </i> </a></div>';t.el.append(a(l)),t.gid=e;var n=a(r);t.$new=n,t.el.append(n),a(".gallery-button",n).on("click",function(e){e.preventDefault();a(this);top.layer.open({type:2,title:"选择",shadeClose:!1,shade:.2,shift:10,area:["55%","70%"],content:t.url,btn:["确定","关闭"],yes:function(e,l){var r=top.window["layui-layer-iframe"+e].rows,n=[];for(i=0;i<r.length&&i<t.maxnum;i++)row=r[i],_.isUndefined(row.type)||(row.type=row.type),t.rows.push(row),n.push(row.id);a("#param_"+t.name).val(n.toString()).change(),t.reload(),top.layer.close(e)}})})},getItem:function(a){for(i=0;i<this.rows.length;i++)if(this.rows[i].id==a)return!0;return!1},loadData:function(a){for(i=0;i<a.length;i++)this.getItem(a[i].id)||this.rows.push(a[i]);this.reload()},reload:function(){var t=this,e=t.width,l=t.height,r=e-6,n=l-6;for(i=0;i<t.rows.length;i++)if(!t.rows[i].loaded){t.rows[i].loaded=!0;var s=t.rows[i],d=1==s.checked?"selected":"",o=1==s.type||4==s.type?"gallery-img":"download",c='<div class="gallery-tile '+d+'" style="width:'+e+"px; height:"+l+'px;"><div class="corner"> </div><div class="gallery-tile-body"><a href="'+s.url+'" class="'+o+'" data-id="'+s.id+'"><img src="'+s.lpreviewUrl+'" style="width:'+r+"px; height:"+n+'px;"/></a></div><div class="gallery-tile-object"><span class="name">'+s.name+'</span><span class="number">'+s.hits+"</span></div>";if(!t.noabar){c+='<div class="gallery-tile-abar">',t.settingAction&&(c+=' <button class="btn btn-xs default gallery-setting" data-id="'+s.f2m_id+'"><i class="fa fa-cog"> </i></button>'),t.downloadAction&&(c+=' <a href="#" class="btn btn-xs default gallery-download" ><i class="fa fa-download"> </i></a>'),t.deleteAction&&(c+=' <button class="btn btn-xs red gallery-delete"><i class="fa fa-trash-o"> </i></button>');var h=1==s.checked?"fa-check-square":"fa-square";c+=' <button class="btn btn-xs yellow gallery-check" data-checked='+s.checked+' data-id="'+s.id+'">',c+='<i class="fa '+h+'"> </i>',c+='<input type="hidden" name="params['+t.name+"]["+s.id+']" value="'+s.checked+'">',c+="</button>",c+="</div></div>"}var u=a(c);t.$new.before(u),a(".gallery-img",u).on("click",function(e){e.preventDefault();var i=a(this).attr("data-id");t.showGallery(i)}),a(".gallery-delete",u).on("click",function(e){e.preventDefault(),a(this).closest(".gallery-tile").remove(),t.rows.pop(),t.rows.length<t.maxnum&&t.$new.show()}),a(".gallery-check",u).on("click",function(e){e.preventDefault();var i=a(this).attr("data-id"),l=a(this),r=parseInt(l.attr("data-checked"));if(1==r?l.find("i").toggleClass("fa-check-square fa-square"):l.find("i").toggleClass("fa-square fa-check-square"),l.closest(".gallery-tile").toggleClass("selected"),r=l.closest(".gallery-tile").hasClass("selected")?1:0,l.find("input").val(r),r){var n=t.url+"/fileinfo?id="+i;a.get(n,function(t){0==t.status&&(""==a("#param_name").val()&&a("#param_name").val(t.data.title),_.isUndefined(t.data.previewUrl)||a("#param_photo").val(t.data.previewUrl),_.isUndefined(t.data.playurl)||a("#param_video").val(t.data.playurl))}).error(function(){rui.showTError("系统错误！")})}}),a(".gallery-setting",u).on("click",function(e){e.preventDefault();var i=a(this).attr("data-id"),l=t.url+"/setgallery?dlg=1&id="+i;layer.open({type:2,title:"设置",shadeClose:!0,shade:.2,maxmin:!0,shift:10,area:["70%","65%"],content:l})})}(i>=t.maxnum||1==t.noabar)&&t.$new.hide(),t.el.append('<div class="clearfix"></div>'),t.el.sortable&&t.el.sortable({connectWith:".gallery-tile",handle:".gallery-tile-abar",placeholder:"gallery-placeholder"})},showGallery:function(a){var t=[],e=0,l=0;for(i=0;i<this.rows.length;i++){var r=this.rows[i],n=r.url,s=r.mimetype,d={title:r.title,href:n,type:s,poster:r.url};t.push(d),a==r.id&&(l=e),e++}var o="#"+this.gid;blueimp.Gallery(t,{container:o,carousel:!0,index:l})}},a(document).ready(function(){a(".gallery").each(function(){new t(a(this))})})}(jQuery);