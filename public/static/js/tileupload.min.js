!function($){var TileFileupload=function(e){this.initialize(e)};TileFileupload.prototype={options:{},el:null,$fileupload:null,fileupload:null,url:window.location.href,model:"",tpl:"tile",mid:0,viewcontent:0,viewcontentEl:"#viewcontent",autoupload:!1,uptype:"gif|jpe?g|png|doc|docx|xls|ppt|pptx|xlsx|pdf|txt|zip|tar|gz|bz2|lz|mp3|mp4|flv|avi|mpeg|ogg|mkv",maxFileSize:2147483647,maxnum:2147483647,showlimit:0,multiple:!0,nopreview:!1,donereload:!1,sbt:"",button_title:"upload",ladda:null,id:0,name:null,width:240,height:180,initialize:function(options){var self=this,el=options.el,$el=$(el);self.options=options,void 0!==options.autoupload&&(self.autoupload=options.autoupload),void 0!==$el.attr("data-url")&&(self.url=$el.attr("data-url")),void 0!==$el.attr("data-sbt")&&(self.sbt=$el.attr("data-sbt")),void 0!==$el.attr("data-tpl")&&(self.tpl=$el.attr("data-tpl")),void 0!==$el.attr("data-model")&&(self.model=$el.attr("data-model")),void 0!==$el.attr("data-mid")&&(self.mid=parseInt($el.attr("data-mid"))),void 0!==$el.attr("data-autoupload")&&(self.autoupload=!0),void 0!==$el.attr("data-single")&&(self.multiple=!1),void 0!==$el.attr("data-maxsize")&&(self.maxFileSize=parseInt($el.attr("data-maxsize"))),void 0!==$el.attr("data-maxnum")&&(self.maxnum=parseInt($el.attr("data-maxnum"))),void 0!==$el.attr("data-uptype")&&(self.uptype=$el.attr("data-uptype")),void 0!==$el.attr("data-button-title")&&(self.button_title=$el.attr("data-button-title")),void 0!==$el.attr("data-nopreview")&&(self.nopreview=!0),void 0!==$el.attr("data-donereload")&&(self.donereload=!0),void 0!==$el.attr("data-showlimit")&&(self.showlimit=parseInt($el.attr("data-showlimit"))),void 0!==$el.attr("data-viewcontent")&&(self.viewcontentEl=$el.attr("data-viewcontent")),void 0!==$el.attr("data-id")&&(self.id=$el.attr("data-id")),void 0!==$el.attr("data-name")&&(self.name=$el.attr("data-name")),void 0!==$el.attr("data-width")&&(self.width=parseInt($el.attr("data-width"))),void 0!==$el.attr("data-height")&&(self.height=parseInt($el.attr("data-height"))),self.el=el,self.$fileupload=$el,"tile"==self.tpl?self.initTplTile():"table"==self.tpl?self.initTplTable():"button"==self.tpl?(self.initTplButton(),self.autoupload=!0):"simplebutton"==self.tpl?(self.initTplSimpleButton(),self.autoupload=!0,self.nopreview=!0,self.donereload=!0):"fileselectbutton"==self.tpl?self.initTplFileselectbutton():"fileselector"==self.tpl&&(self.initTplFileselector(),self.autoupload=!0,self.nopreview=!0,self.viewcontent=1),self.$fileupload.fileupload({type:"POST",url:self.url+"/upload",disableImageResize:!1,previewMaxWidth:self.width-6,previewMaxHeight:self.height-6,previewCrop:!0,autoUpload:self.autoupload,disableImageResize:/Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),maxFileSize:self.maxFileSize,acceptFileTypes:eval("/(.)("+self.uptype+")$/i"),uploadTemplateId:null,downloadTemplateId:null,uploadTemplate:function(e){var l=$(),t=e.files.length;if(t>0&&"fileselector"==self.tpl)return!0;for(i=0;i<t;i++){var a=e.files[i],s="";"table"==self.tpl?(s='<tr class="template-upload fade"> <td>    <span class="preview"></span></td><td>    <p class="name">'+a.name+'</p>    <strong class="error text-danger label label-danger"></strong></td><td>    <p class="size">Processing...</p>    <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">    <div class="progress-bar progress-bar-success" style="width:0%;"></div>    </div></td><td>',index||e.options.autoUpload||(s+='<button class="btn blue start" disabled><i class="fa fa-upload"></i><span>Start</span></button>'),index||(s+='<button class="btn red cancel">     <i class="fa fa-ban"></i>     <span>Cancel</span></button>'),s+="</td></tr>"):(s='<div class="tile image bg-grey-light template-upload fade" style="width:'+self.width+"px; height:"+self.height+'px;"><input type="hidden" name="params['+self.name+'][]" value="'+a.id+'"> <div class="tile-body preview" > </div> <div class="tile-object"> <div class="name">          <span title="'+a.name+'">'+a.name+'</span>     </div>     <div class="number">     </div> </div> <div class="tile-size">     <span class="size">'+e.formatFileSize(a.size)+'</span> </div> <div class="tile-progress">    <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">     <div class="progress-bar progress-bar-success" style="width:0%;"></div>    </div> </div> <div class="tile-error">     <strong class="error text-danger label label-danger"></strong> </div> <div class="tile-actions">',i||e.options.autoUpload||(s+='         <div class="btn-group btn-group-xs btn-group-solid">             <button class="btn blue start" title="Start" disabled >                 <i class="fa fa-upload"></i>             </button>            <button type="reset" class="btn btn-xs red cancel" title="Cancel">                    <i class="fa fa-ban"></i>             </button>         </div>'),s+="</div></div>");var o=$(s);if(o.find(".name").text(a.name),a.error&&o.find(".error").text(a.error),l=l.add(o),i+1==self.maxnum){$(".uploadfileinput",self.$fileupload).hide();break}}return l},downloadTemplate:function(e){var l=$(),a=e.files.length;if(a>0&&"button"==self.tpl){var s=$(".tile",self.$fileupload).width(),o=$(".popover",self.$fileupload).width();o<s*(a+1)&&$(".popover",self.$fileupload).width(o+(s+10)*a)}else if(a>0&&"fileselectbutton"==self.tpl)return self.updateFileselectbuttonStatus(2,e.files[0]),!0;for(i=0;i<a;i++){var d=e.files[i],n=(self.url,d.url,d.previewUrl),r=d.lpreviewUrl,p=d.deleteUrl,u=d.downloadUrl;"string"==typeof d.size&&(d.size=parseInt(d.size));var f="",c="";(d.mid>0||1==d.upload)&&(f="selected",c="checked");var v="";if("table"==self.tpl)v+='<tr class="template-download fade">    <td>        <span class="preview">                <a href="'+r+'" title="'+d.name+'" download="'+d.name+'" data-gallery><img src="'+n+"?id="+d.id+'"></a>        </span>    </td>    <td>        <p class="name">                <a href="'+r+'" title="'+d.name+'" download="{%=file.name%}" data-gallery >'+d.name+"</a>        </p>",d.error&&(v+='<div><span class="label label-danger">Error</span> '+d.error+"</div>"),v+='    </td>    <td>        <span class="size">'+e.formatFileSize(d.size)+'</span>    </td>    <td>            <button class="btn red delete btn-sm" data-type="'+d.deleteType+'" data-url="'+d.deleteUrl+'">                <i class="fa fa-trash-o"></i>                <span>Delete</span>            </button>            <input type="checkbox" name="delete" value="1" class="toggle">    </td></tr>';else{var b=self.width-6,g=self.height-6;v='<div class="tile '+f+' image bg-grey-light template-download fade" id="tile_'+d.id+'"><input type="hidden" name="params['+self.name+'][]" value="'+d.id+'"><div class="tile-body preview">     <a href="'+r+'" title="'+d.name+'" download="'+d.name+'" data-gallery>     <img src="'+n+'" style="width:'+b+"px; height:"+g+'px;" /></a> </div> <div class="tile-object">     <div class="name">     <a href="'+r+'" title="'+d.name+'" download="'+d.name+'" data-gallery>'+d.name+'</a> </div> </div> <div class="tile-size">     <span class="size">'+e.formatFileSize(d.size)+"</span> </div>",v+='<div class="tile-actions"><div class="btn-group btn-group-xs btn-group-solid"> <button type="button" href="'+u+"?id="+d.id+'" class="btn green btn-xs download" title="'+t("Download")+'" >     <i class="fa fa-download"></i> </button>  <button class="btn btn-xs red delete" title="'+t("Delete")+'" data-type="'+d.deleteType+'"      data-url="'+p+"?id="+d.id+'" >     <i class="fa fa-trash-o"></i> </button> <input type="checkbox" name="fileids['+d.id+']" value="'+d.id+'" class="selectfile" '+c+" >  </div> </div></div>"}var h=$(v);if(l=l.add(h),i+1==self.maxnum){$(".uploadfileinput",self.$fileupload).hide();break}}return l}}).on("fileuploadadd",function(e,data){var acceptFileTypes=eval("/(.)("+self.uptype+")$/i");for(i=0;i<data.originalFiles.length;i++){var name=data.originalFiles[i].name;if(!acceptFileTypes.test(name))return void rui.showTError("上传文件类型错误！");var size=data.originalFiles[i].size;if(size>self.maxFileSize)return data.abort(),void self.uploadBigFile(name)}if(self.autoupload||$(".fileupload-buttonbar",self.$fileupload).show(),"button"==self.tpl){var tilewidth=$(".tile",self.$fileupload).width(),popwidth=$(".popover",self.$fileupload).width();$(".popover",self.$fileupload).width(popwidth+tilewidth+10),self.$pop.popover("show")}else"fileselectbutton"==self.tpl&&self.updateFileselectbuttonStatus(1,data.files[0]);self.ladda&&self.ladda.start(),self.fileupload=data}).on("fileuploadfail",function(e,l){l.originalFiles.length<=1&&$(".fileupload-buttonbar",self.$fileupload).hide()}).on("fileuploadsubmit",function(e,l){l.formData={sbt:self.sbt,model:self.model,mid:self.mid,viewcontent:self.viewcontent},$(".tile-progress",self.$fileupload).show()}).on("fileuploaddone",function(e,l){if(console.log(l.result),l.result.status<0)return rui.showTError("操作失败:"+l.result.status),!1;if(rui.showTSuccess("上传成功"),self.donereload)return rui.refresh(1),!0;if($(".tile-progress",self.$fileupload).hide(),self.autoupload||$(".fileupload-buttonbar",self.$fileupload).hide(),self.viewcontent&&void 0!==l.result.files[0].content){var t=base64_decode(l.result.files[0].content);$(self.viewcontentEl).val(t)}}).on("fileuploadcompleted",function(e,l){self.$fileupload.on("click",".download",function(e){e.preventDefault();var l=$(this).attr("href");rui.redirect(l)}),self.$fileupload.on("change",".selectfile",function(e){e.preventDefault();$(this).is(":checked");var l=$(this).val();$("#tile_"+l,self.$fileupload).toggleClass("selected")})}).on("fileuploaddestroy",function(e,l){return rui.ask(t("Are you sure to delete?"))}).on("fileuploaddestroyed",function(e,l){$(".uploadfileinput",self.$fileupload).show()}).on("fileuploadprogress",function(e,l){var t=l.loaded/l.total;self.ladda&&(self.ladda.setProgress(t),l.loaded==l.total&&self.ladda.stop())}),self.$fileupload.addClass("fileupload-processing"),self.maxnum>0&&!self.nopreview&&$.ajax({url:self.url+"/list",dataType:"json",data:{model:self.model,mid:self.mid,showlimit:self.showlimit},context:self.$fileupload[0]}).always(function(){$(this).removeClass("fileupload-processing")}).done(function(e){$(this).fileupload("option","done").call(this,$.Event("done"),{result:{files:e.files}})})},initTplTable:function(){this.multiple;this.$fileupload.append('<div class="row fileupload-buttonbar"><div class="col-lg-7">    \x3c!-- The fileinput-button span is used to style the file input field as button --\x3e    <span class="btn green fileinput-button">    <i class="fa fa-plus" ></i>    <span>    Add files... </span>    <input type="file" name="files[]" multiple="">    </span>    <button type="submit" class="btn blue start">    <i class="fa fa-upload"></i>    <span>    Start upload </span>    </button>    <button type="reset" class="btn red cancel">    <i class="fa fa-ban-circle"></i>    <span>    Cancel upload </span>    </button>\t    \x3c!-- The global file processing state --\x3e    <span class="fileupload-process">    </span></div>\x3c!-- The global progress information --\x3e<div class="col-lg-5 fileupload-progress fade">    \x3c!-- The global progress bar --\x3e    <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">        <div class="progress-bar progress-bar-success" style="width:0%;">        </div>    </div>     \x3c!-- The extended global progress information --\x3e    <div class="progress-extended">         &nbsp;    </div></div></div>\x3c!-- The table listing the files available for upload/download --\x3e<table role="presentation" class="table table-striped clearfix"><tbody class="files"></tbody></table>')},initTplTile:function(){var e=this.multiple?"multiple":"",l=$('<div class="fileupload">                                                                                                                     <div class="files"></div>                                                                                                           <div class="tile bg-grey-light selected template-upload uploadfileinput" style="width:'+this.width+"px; height:"+this.height+'px;">                                                                               <div class="tile-body fileinput">                                                                                                       <span class="fileinput-button">                                                                                                     <i class="fa fa-plus" style="line-height:'+this.height+"px; width:"+this.width+'px;"></i>                                                                                                          <input type="file" name="files[]" '+e+' title="Add files... ">                                                            </span>                                                                                                                         </div>                                                                                                                                                                                                                                                                  <div class="tile-progresscircle">                                                                                                       <button type="button" class="btn btn-circle green-haze">                                                                                <i class="progresscircle">a</i>                                                                                                 </button>                                                                                                                       </div>                                                                                                                                                                                                                                                                                                                                                                                                      <div class="tile-progress fileupload-progress">                                                                                        <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">            <div class="progress-bar progress-bar-success" style="width:0%;"></div>                                                             </div>                                                                                                                          </div>                                                                                                                                                                                                                                                                  <div class="tile-actionbar fileupload-buttonbar">                                                                                       <div class="btn-group btn-group-xs btn-group-solid">                                                                                    <button type="submit" class="btn btn-xs green start" title="Start upload all">                                                          <i class="fa fa-upload"></i>                                                                                                    </button>                                                                                                                                                                                                                                                               <button type="reset" class="btn btn-xs red cancel" title="Cancel upload all">                                                              <i class="fa fa-ban"></i>                                                                                                    </button>                                                                                                                       </div>                                                                                                                          </div>                                                                                                                          </div>                                                                                                                          </div><div id="blueimp-gallery" class="blueimp-gallery blueimp-gallery-controls" data-filter=":even"><div class="slides"></div><h3 class="title"></h3><a class="prev">‹ </a><a class="next">› </a><a class="close white"></a><a class="play-pause"></a><ol class="indicator"></ol></div>');this.$fileupload.append(l)},initTplButton:function(){var e=this,l=e.multiple?"multiple":"",t=$('<div class="fileupload popover fade " id="tplPopover">      <span class="arrow"></span>    <div class="files"></div>     <div class="tile bg-grey-light selected template-upload uploadfileinput">         <div class="tile-body fileinput">             <span class="btn fileinput-button">                 <i class="fa fa-plus" style="line-height:'+e.height+'px;"></i>                                                                                                          <input type="file" class="inputfile" name="files[]" '+l+' title=" ... ">                                                            </span>                                                                                                                         </div>                                                                                                                                                                                                                                                                  <div class="tile-progresscircle">                                                                                                       <button type="button" class="btn btn-circle green-haze">                                                                                <i class="progresscircle">a</i>                                                                                                 </button>                                                                                                                       </div>                                                                                                                                                                                                                                                                                                                                                                                                      <div class="tile-progress fileupload-progress">                                                                                        <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">            <div class="progress-bar progress-bar-success" style="width:0%;"></div>                                                             </div>                                                                                                                          </div>                                                                                                                                                                                                                                                                  <div class="tile-actionbar fileupload-buttonbar">                                                                                       <div class="btn-group btn-group-xs btn-group-solid">                                                                                    <button type="submit" class="btn btn-xs green start" title="Start upload all">                                                          <i class="fa fa-upload"></i>                                                                                                    </button>                                                                                                                                                                                                                                                               <button type="reset" class="btn btn-xs red cancel" title="Cancel upload all">                                                              <i class="fa fa-ban"></i>                                                                                                    </button>                                                                                                                       </div>                                                                                                                          </div>                                                                                                                          </div>                                                                                                                          </div><div id="blueimp-gallery" class="blueimp-gallery blueimp-gallery-controls" data-filter=":even"><div class="slides"></div><h3 class="title"></h3><a class="prev">‹ </a><a class="next">› </a><a class="close white"></a><a class="play-pause"></a><ol class="indicator"></ol></div>'),a=$('        <button type="button" class="btn blue" id="btnTileFileUpload">            <i class="fa fa-upload"> '+e.button_title+' </i>         </button>        <button type="button" class="btn blue dropdown-toggle" data-toggle="popover">            <i class="fa fa-angle-down">&nbsp; </i>        </button>');this.$fileupload.append(a),this.$fileupload.append(t),this.$pop=$("[data-toggle='popover']",this.$fileupload).popover({trigger:"click",placement:"bottom",template:"#tplPopover",title:"",html:!0,content:" "}),$("#btnTileFileUpload",this.$fileupload).on("click",function(l){$(".inputfile",e.$fileupload).trigger("click")})},initTplSimpleButton:function(){this.ladda=Ladda.create(this.el)},initTplFileselectbutton:function(){var e=this;e.$fileupload.append('<div class="fileinput fileinput-new" data-provides="fileinput">    <div class="input-group input-large al">        <div class="form-control" data-trigger="fileinput">            <i class="fa fa-file "></i>&nbsp;            <span class="fileinput-filename"><input type="file" class="inputfile" name="..."> </span>         </div>        <span class="input-group-btn">         <button type="button" class="btn default fileinput-action">选择</button>       </span>    </div></div>'),$(".fileinput-action",e.$fileupload).on("click",function(l){var a=$(this);switch(parseInt(a.attr("data-status"))){case 1:e.fileupload&&e.fileupload.submit();break;case 2:bootbox.confirm(t("Are you sure to delete?"),function(e){var l=a.attr("data-url");$.getJSON(l,function(e){0==e.status?(rui.showTSuccess("操作成功"),rui.refresh(1)):rui.showTError("操作失败:"+e.status)}).error(function(){rui.showTError("系统错误")})});break;default:$(".inputfile",e.$fileupload).trigger("click")}})},updateFileselectbuttonStatus:function(e,l){var t=$(".fileinput-action",this.$fileupload);switch(t.attr("data-status",e),e){case 1:t.text("上 传"),this.$fileupload.find(".fileinput-filename").text(l.name),t.addClass("green").removeClass("red");break;case 2:t.text("删除"),t.addClass("red").removeClass("green"),t.attr("data-url",l.deleteUrl+"?id="+l.id),$(".fileinput-filename",this.$fileupload).text(l.name)}},initTplFileselector:function(){},uploadBigFile:function(e){for(var l="",t=document.cookie.split(";"),a=0;a<t.length;a++){var i=t[a].trim();if(0==i.indexOf("ssid")){l=i;break}}var s=window.location.protocol+"//"+window.location.host+this.url+"/?tt=1&"+l+"&lp="+e;s=s.replace("http","icloud"),window.location=s}},$.fn.tileupload=function(e){"string"==typeof e&&(e={text:e}),e=$.extend({},{width:256,height:256},e);return this.each(function(){!function(l){e.el=l;new TileFileupload(e)}(this)})}}(jQuery);