<style type="text/css">
	.login .content button{ vertical-align:top;}
	.login .content input{font-size: 16px !important; vertical-align:middle;}
	.login .banner {width: 480px; }
	.login .content {padding: 0px; width: 480px; }
	.login .light {background:rgba(255, 255, 255, 0.5); }
</style>
<!-- BEGIN LOGION WRAPPER -->
<div class="login-wrapper">
<!-- BEGIN LOGIN BANNER -->
<div class="banner">
    <i class="icon-lock"></i> @t[Welcome login]
</div>
<!-- END LOGIN BANNER -->
        <!-- BEGIN LOGIN -->
        <div class="content" >
            <div class="portlet  light login-content">
                            <div class="portlet-title tabbable-line">
                                
                                <ul class="nav nav-tabs">
                                    <li class="active">
                                        <a href="#tab1" data-toggle="tab" class="t4 bold">@t[Name]</a>
                                    </li>
                                    <li>
                                        <a href="#tab2" data-toggle="tab" class="t4 bold">@t[Seccode]</a>
                                    </li>

                                    <li>
                                        <a href="#tab3" data-toggle="tab" class="t4 bold hidden">@t[Scaning]</a>
                                    </li>

                                    <li>
                                        <a href="#tab4" data-toggle="tab" class="t4 bold">@t[Sign]</a>
                                    </li>
                                </ul>
                                
                            </div>

                            <div class="portlet-body ">
                                
                                <div class="tab-content margin-top-20 margin-bottom-30">
                                        <div class="tab-pane active" id="tab1">
                                            <form class="login-form " action="$_base" method="post">
                                            	<input type="hidden" name="pkey" value="$__aeskey" id="param_pkey" />
                								<input type="hidden" name="sbt" value="$sbt" />
                                                <input type="hidden" name="backurl" value="$backurl" />
                                                <div class="alert alert-danger display-hide">
                                                    <button class="close" data-close="alert"></button>
                                                    <span> @t[Please enter username and password.] </span>
                                                </div>
                                                <div class="form-group">
                                                    <!--ie8, ie9 does not support html5 placeholder, so we just show field title for that-->
                                                    <label class="control-label visible-ie8 visible-ie9">@t[Name/Email/Mobile]</label>
                                                    <div class="input-icon">
                                                        <i class="fa fa-user"></i>
                                                        <input class="form-control placeholder-no-fix" type="text" autocomplete="off" placeholder="@t[Name/Email/Mobile]" name="params[username]" /> </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="control-label visible-ie8 visible-ie9">@t[Password]</label>
                                                    <div class="input-icon">
                                                        <i class="fa fa-lock"></i>
                                                        <input class="form-control placeholder-no-fix" type="password" autocomplete="off" placeholder="@t[Password]" name="params[password]" /> </div>
                                                </div>

                                                <div class="form-group">
                                                    <div class="input-icon sec-icon" >
                                                    <label class="control-label visible-ie8 visible-ie9">@t[Captcha]</label>
                                                    <i class="fa fa-lock"></i>
                                                    <input class="form-control placeholder-no-fix rccode " type="text" name="params[seccode]" autocomplete="off" required placeholder="@t[Captcha]" value="" id="seccode"  />
                                                    <img src="$seccodeimg" class="captcha" id="capimg" alt="@t[captcha]" title="@t[Cannot see the captcha, please click me for reloading]"  />
                                                    
                                                    </div>
                                                </div>
                                                
                                                <div class="form-actions margin-bottom-30">
                                                    <label class="rememberme mt-checkbox mt-checkbox-outline">
                                                        <input type="checkbox" name="params[remember]" value="1" /> @t[Remember]
                                                        <span></span>
                                                    </label>
                                                    <button type="submit" class="btn btn-primary pull-right"> @t[Login] <i class="m-icon-swapright m-icon-white"></i>  </button>
                                                </div>
                                                              
                                                
                                                <div class="login-options">
                                                	<style> .alipay { padding:0px;} </style>                                            
                                                    <div class="pull-left">  
														<!--# foreach($thirdAccountLoginOptions as $key=>$v) { #-->
								                        <a href="$v[url]" class="btn btn-circle btn-icon-only $v[class]">
								                            $v[_icon]
								                        </a>
								                        <!--# } #-->                                                     
                                                    </div>
                                                    
                                                    <ul class="pull-right">
                                                            <a href="javascript:;" id="forget-password"> @t[Forget Password] ? </a> 

                                                            <a href="$_webroot/register" id="newAccount"> @t[Register a account] </a> 
                                                    </ul>
                                                    <div class="clearfix"></div>
                                                </div>
                                            </form>

                                            <!-- BEGIN FORGOT PASSWORD FORM -->
								            <form class="forget-form" action="index.html" method="post">
								                <h3>@t[Forget Password] ?</h3>
								                <p> @t[Enter your e-mail address below to reset your password]. </p>
								                <div class="form-group">
								                    <div class="input-icon">
								                        <i class="fa fa-envelope"></i>
								                        <input class="form-control placeholder-no-fix" type="text" autocomplete="off" placeholder="@t[Email]" name="email" /> </div>
								                </div>
								                <div class="form-actions">
								                    <button type="button" id="back-btn" class="btn blue">@t[Back]</button>
								                    <button type="submit" class="btn green pull-right" id="forgetPassword"> @t[Submit] </button>
								                </div>
								            </form>
								            <!-- END FORGOT PASSWORD FORM -->
								            

                                        </div>
                                        <div class="tab-pane" id="tab2">

                                        	<form class="login-form2" action="$_base/login" method="post">
                                                <input type="hidden" name="pkey" value="$__aeskey" id="param_pkey" />
                                                <input type="hidden" name="sbt" value="$sbt" />
                                                
                                                <div class="alert alert-danger display-hide">
                                                    <button class="close" data-close="alert"></button>
                                                    <span> Enter any username and password. </span>
                                                </div>
                                                <div class="form-group">
                                                    <div class="input-icon">
                                                        <i class="fa fa-phone"></i>
                                                        <input class="form-control placeholder-no-fix" type="text" autocomplete="off" placeholder="@t[Mobile/Email]" name="params[account]" id="param_account" /> </div>
                                                </div>
                                                <div class="form-group">
                                                    <div class="input-icon" style="display: inline-block;">
                                                        <i class="fa fa-key"></i>
                                                        <input class="form-control placeholder-no-fix input-small" type="text" autocomplete="off" placeholder="@t[Security Code]" name="params[seccode]" /> 
                                                    </div>
                                                    <button class="btn btn-default fix-btn" type="button" id="btnGetSecurityCode"> @t[Get Security Code] </button>

                                                    <div class="clearfix"></div>
                                                </div>

                                                                                                
                                                <div class="form-actions">
                                                    <button type="submit" class="btn btn-primary "> @t[Login] </button>
                                                </div>
                                            </form>  

                                            

                                        </div>
                                        <div class="tab-pane" id="tab3" >
                                            <div class="ac"><img src="$_dstroot/img/no.png"/></div>
                                            <div class="ac">@t[Please Scan the QR with APP]</div>
                                        </div>      


                                       <div class="tab-pane" id="tab4">

                                            <form class="register-form3" action="$_base/register" method="post">
                                                <input type="hidden" name="pkey" value="$__aeskey" id="param_pkey" />
                                                <input type="hidden" name="sbt" value="$sbt" />

                                                <div class="alert alert-danger display-hide">
                                                    <button class="close" data-close="alert"></button>
                                                    <span> Enter any username and password. </span>
                                                </div>
                                                <div class="form-group">
                                                    <div class="input-icon">
                                                        <i class="fa fa-user"></i>
                                                        <input class="form-control placeholder-no-fix" type="text" autocomplete="off" placeholder="@t[Username]" name="params[name]" /> </div>
                                                </div>

                                                <div class="form-group">
                                                    <div class="input-icon">
                                                        <i class="fa fa-lock"></i>
                                                        <input class="form-control placeholder-no-fix" type="password" autocomplete="off" placeholder="@t[Password]" name="params[password]" id="param_password" /> </div>
                                                </div>

                                                <div class="form-group">
                                                    <div class="input-icon">
                                                        <i class="fa fa-lock"></i>
                                                        <input class="form-control placeholder-no-fix" type="password" autocomplete="off" placeholder="@t[Retry Password]" name="params[password2]" id="param_password2" /> </div>
                                                </div>



                                                <div class="form-group">
                                                    <div class="input-icon">
                                                        <i class="fa fa-mail"></i>
                                                        <input class="form-control placeholder-no-fix" type="text" autocomplete="off" placeholder="@t[Mobile/Email]" name="params[account]" id="param_account2" /> </div>
                                                </div>
                                                <div class="form-group">

                                                    <div class="input-icon" style="display: inline-block;">
                                                        <i class="fa fa-key"></i>
                                                        <input class="form-control placeholder-no-fix input-small" type="text" autocomplete="off" placeholder="@t[Security Code]" name="params[seccode]" /> 
                                                    </div>

                                                    <button class="btn btn-default fix-btn" type="button" id="btnGetSecurityCode2"> @t[Get Security Code] </button>

                                                    <div class="clearfix"></div>
                                                </div>

                                                                                                
                                                <div class="form-actions">
                                                    <button type="submit" class="btn btn-primary">@t[Sign]</button>
                                                </div>
                                                
                                            </form>                                            
                                        </div>
                                </div>
                            </div>
                        </div>
            
            
        </div>

<!-- END LOGIN -->
</div>
<!-- END LOGION WRAPPER -->
<script language="javascript">

jQuery(document).ready(function() {	

	var genSecCode = function() 
	{
	   $("#capimg").attr("src", G.basename+"/seccode/?r="+Math.random());
    }

	var handleLogin = function() {
		$('.login-form').validate({
	            errorElement: 'span', //default input error message container
	            errorClass: 'help-block', // default input error message class
	            focusInvalid: false, // do not focus the last invalid input
	            rules: {
	                'params[username]': {
	                    required: true
	                },
	                'params[password]': {
	                    required: true
	                },

	                'params[captcha]': {
	                    required: true
	                },
	                	                
	                remember: {
	                    required: false
	                }
	            },

	            messages: {
	                'params[username]': {
	                    required: t("Username is required.")
	                },
	                'params[password]': {
	                    required: t("Password is required.")
	                },
	                'params[captcha]': {
	                    required: t("Captcha is required.")
	                }
	            },

	            invalidHandler: function (event, validator) { //display error alert on form submit   
	                $('.alert-danger', $('.login-form')).show();
	            },

	            highlight: function (element) { // hightlight error inputs
	                $(element)
	                    .closest('.form-group').addClass('has-error'); // set error class to the control group
	            },

	            success: function (label) {
	                label.closest('.form-group').removeClass('has-error');
	                label.remove();
	            },

	            errorPlacement: function (error, element) {
	                error.insertAfter(element.closest('.input-icon'));
	            },

	            submitHandler: function (form) {
	            	//取 key
		            var pkey = $('#param_pkey').val();
            		
		            var formData = $(form).serializeArray();
            		
	                for (i=0; i<formData.length; i++) {
	  		            if (formData[i].name == "params[password]") {
	  			            var val = formData[i].value;
	  			            var _val = encrypt(val, pkey);
	  			            formData[i].value = _val;
	  		            }
	               }
            	           
                   rui.post(G.base+'/login', formData).then(function(res) {
                        if (res.status == 0) {
                            var url = _.isUndefined(res.data.backurl)?G.basename:res.data.backurl;
                            rui.redirect(url);               
                        } else {
                           var msg = '操作失败:'+res.status;
                            if (res.msg)
                                msg = res.msg;
                            rui.showTError(msg);
                        }
                    });  
	            }
	        });

	        $('.login-form input').keypress(function (e) {
	            if (e.which == 13) {
	                if ($('.login-form').validate().form()) {
	                    $('.login-form').submit();
	                }
	                return false;
	            }
	        });
	        $("#capimg").on('click', genSecCode);
	        //genSecCode();
	        
	}
	
	function doForgetPassword(form)
	{
	    console.log('doForgetPassword todo...');
	
	    var formData = $(form).serializeArray();
	    rui.post(G.base+'/forgetPassword', formData).then(function(res) {
            if (res.status == 0) {
                 rui.showTSuccess('操作成功，请查收邮件');                
            } else {
               rui.showTError('操作失败:'+res.status, '.content');
            }
        });  
	    
	}
	
	var handleForgetPassword = function () {
		$('.forget-form').validate({
	            errorElement: 'span', //default input error message container
	            errorClass: 'help-block', // default input error message class
	            focusInvalid: false, // do not focus the last invalid input
	            ignore: "",
	            rules: {
	                email: {
	                    required: true,
	                    email: true
	                }
	            },

	            messages: {
	                email: {
	                    required: "@t[Email is required].",
	                    email: "@t[Please enter a valid email address]."
	                }
	            },

	            invalidHandler: function (event, validator) { //display error alert on form submit   

	            },

	            highlight: function (element) { // hightlight error inputs
	                $(element)
	                    .closest('.form-group').addClass('has-error'); // set error class to the control group
	            },

	            success: function (label) {
	                label.closest('.form-group').removeClass('has-error');
	                label.remove();
	            },

	            errorPlacement: function (error, element) {
	                error.insertAfter(element.closest('.input-icon'));
	            },

	            submitHandler: function (form) {
	                doForgetPassword(form);
	            }
	        });

	        $('.forget-form input').keypress(function (e) {
	            if (e.which == 13) {
	                if ($('.forget-form').validate().form()) {
	                   $('.forget-form').submit();
	                }
	                return false;
	            }
	        });
	        
	       

	        jQuery('#forget-password').click(function () {
	            jQuery('.login-form').hide();
	            jQuery('.forget-form').show();
	        });

	        jQuery('#back-btn').click(function () {
	            jQuery('.login-form').show();
	            jQuery('.forget-form').hide();
	        });

	}

   //验证码登录
   var timeout = parseInt("$seccodetimeout");       
   function waitingGetSecurityCode()
   {    //倒计时
        var el = $('#btnGetSecurityCode');
        if (timeout -- > 0) {
            el.prop('disabled', true);
            el.html(timeout+'秒后超时');
            
            setTimeout(waitingGetSecurityCode, 1000);
        } else {
             el.prop('disabled', false);
             el.html("@t[Retry Get Security Code]");
             timeout = parseInt("$seccodetimeout");
        }
   }
   
   $('#btnGetSecurityCode').on('click', function(e) {
        var account = $('#param_account').val();
        if (account == '')
            return false;
        
        $.post('$_base/sendSecurityCode', {'account':account}, function(res) {
            if (res.status == 0) {
                rui.showTSuccess('操作成功.'); 
                waitingGetSecurityCode();                                       
            } else {
               rui.showTError('操作失败:'+res.status);
            }
        }).error(function(){
              rui.showTError('系统错误！');      
        });
   });

   $('.login-form2').validate({
                errorElement: 'span', //default input error message container
                errorClass: 'help-block', // default input error message class
                focusInvalid: false, // do not focus the last invalid input
                rules: {
                    'params[account]': {
                        required: true,
                    },
                    'params[seccode]': {
                        required: true,
                    },
                },
                messages: {  
                    'params[account]': {
                        required: t("Account is required."),
                    },  
                    'params[seccode]': {
                        required: t("Seccode is required."),
                    },             
                },

                invalidHandler: function (event, validator) { //display error alert on form submit   
                    $('.alert-danger', $('.login-form')).show();
                },

                highlight: function (element) { // hightlight error inputs
                    $(element)
                        .closest('.form-group').addClass('has-error'); // set error class to the control group
                },

                success: function (label) {
                    label.closest('.form-group').removeClass('has-error');
                    label.remove();
                },

                errorPlacement: function (error, element) {
                    error.insertAfter(element);
                },

                submitHandler: function (form) {
                    showWaiting("请稍后。。。");                              
                       var  formData = $(form).serializeArray();
                       //console.log(formData);                       
                       $.post(form.action, formData, function(res) {
                            if (res.status == 0) {
                                rui.showTSuccess('操作成功.');
                                rui.redirect(G.basename);    
                            } else {
                               rui.showTError('操作失败:'+res.status);
                            }
                        }).error(function(){
                              rui.showTError('系统错误！');      
                        }); 
                    closeWaiting();
                }
       });



	var handleRegister = function () {

         $('.register-form3').validate({
	            errorElement: 'span', //default input error message container
	            errorClass: 'help-block', // default input error message class
	            focusInvalid: false, // do not focus the last invalid input
	            ignore: "",
	            rules: {
	                
	                'params[name]': {
	                    required: true
	                },
	                'params[password]': {
	                    required: true
	                },
	                'params[password2]': {
	                    equalTo: "#param_password"
	                },

	                'params[account]': {
	                    required: true
	                },
                    'params[seccode]': {
                        required: true
                    },
                    tnc: {
                        required: true
                    }
	            },

	            messages: { // custom messages for radio buttons and checkboxes
                    'params[name]': {
                        required: t("This field is required."),
                    },
                    'params[password]': {
                        required: t("This field is required."),
                    },
                    'params[password2]': {
                        required: t("This field is required."),
                    },
                    'params[account]': {
                        required: t("This field is required."),
                    },
                    'params[seccode]': {
                        required: t("This field is required."),
                    },
                    
	                tnc: {
	                    required: "Please accept TNC first."
	                }
	            },

	            invalidHandler: function (event, validator) { //display error alert on form submit   

	            },

	            highlight: function (element) { // hightlight error inputs
	                $(element)
	                    .closest('.form-group').addClass('has-error'); // set error class to the control group
	            },

	            success: function (label) {
	                label.closest('.form-group').removeClass('has-error');
	                label.remove();
	            },

	            errorPlacement: function (error, element) {
	                if (element.attr("name") == "tnc") { // insert checkbox errors after the container                  
	                    error.insertAfter($('#register_tnc_error'));
	                } else if (element.closest('.input-icon').size() === 1) {
	                    error.insertAfter(element.closest('.input-icon'));
	                } else {
	                	error.insertAfter(element);
	                }
	            },

	            submitHandler: function (form) {
	               showWaiting("请稍后。。。");                              
                   var  formData = $(form).serializeArray();
                   var pkey = $('#param_pkey').val();
                   //加密
                   for (i=0; i<formData.length; i++) {
                        if (formData[i].name == "params[password]" || formData[i].name == "params[password2]") {
                            var val = formData[i].value;
                            var _val = encrypt(val, pkey);
                            formData[i].value = _val;
                        }
                   }                          

                   //console.log(formData);                       
                   $.post(form.action, formData, function(res) {
                        if (res.status == 0) {
                            rui.showTSuccess('操作成功.');
                            rui.refresh(3);    
                        } else {
                           rui.showTError('操作失败:'+res.status);
                        }
                    }).error(function(){
                          rui.showTError('系统错误！');      
                    }); 
                    closeWaiting();
	            }
	        });

			$('.register-form3 input').keypress(function (e) {
	            if (e.which == 13) {
	                if ($('.register-form3').validate().form()) {
	                    $('.register-form3').submit();
	                }
	                return false;
	            }
	        });


            //验证码

            //验证码登录
           var timeout2 = parseInt("$seccodetimeout");       
           function waitingGetSecurityCode2()
           {    //倒计时
                var el = $('#btnGetSecurityCode2');
                if (timeout2 -- > 0) {
                    el.prop('disabled', true);
                    el.html(timeout+'秒后超时');
                    
                    setTimeout(waitingGetSecurityCode2, 1000);
                } else {
                     el.prop('disabled', false);
                     el.html("@t[Retry Get Security Code]");
                     timeout2 = parseInt("$seccodetimeout");
                }
           }
           
           $('#btnGetSecurityCode2').on('click', function(e) {
                var account = $('#param_account2').val();
                if (account == '')
                    return false;
                
                $.post('$_base/sendSecurityCode', {'account':account}, function(res) {
                    if (res.status == 0) {
                        rui.showTSuccess('操作成功.'); 
                        waitingGetSecurityCode2();                                       
                    } else {
                       rui.showTError('操作失败:'+res.status);
                    }
                }).error(function(){
                      rui.showTError('系统错误！');      
                });
           });

	}

            if (!_.isUndefined(G._i18ndb)) {
        	    I18N.register(G._i18ndb); 
        	} 
        	
        	if (typeof G_i18ndb != "undefined") {
        		I18N.register(G_i18ndb); 
        	}
        	
        	handleLogin(); 
            handleForgetPassword();
            handleRegister(); 
           
           var bgdb = G._bgdb;

           var bgdir = G._dstroot+'/img/bg/';
           var defaultbg = [
						bgdir + '1.jpg',  
						bgdir + '2.jpg', 
						bgdir + '3.jpg'];
				
           if (!_.isArray(bgdb) || bgdb.length == 0)
                bgdb = defaultbg;
            // init background slide images
            $.backstretch(bgdb, {
			      fade: 1000,
			      duration: 8000
					});
});


</script>    